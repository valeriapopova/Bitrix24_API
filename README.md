# API bitrix для оповещения о новых лидах


Метод, позвляющий сохранять лиды из вк в битрикс


***/bitrix*** доступ к api bitrix

___POST___

_/bitrix/post_ - Отправляет новые лиды(например из вк) по указанному url битрикс24

*Parameters*


json - данные которые нужно перенаправить должны иметь такой вид и содержать url bitrix24

```
{
 "data": [{"name": name}, {"phone": phone}],
  "url" - url вида "https://example.bitrix24.com/rest/1/33olqeits4avuyqu"
}
```


Responses 201 успешно

___POST___

_/bitrix/get_leads_ - Забирает лиды из битрикс24

*Parameters*


json - данные которые нужно перенаправить должны иметь такой вид и содержать url bitrix24

```
{
  "url" - url вида "https://example.bitrix24.com/rest/1/33olqeits4avuyqu"
}
```


Responses 201 успешно



*Создать исходящий вебхук можно из раздела Разработчикам (Приложения > Маркет > Разработчикам, вкладка "Готовые сценарии" > Другое > Исходящий вебхук).*

- В открывшейся форме:

    - измените название вебхука;
    - укажите URL вашего обработчика - страницу на стороннем ресурсе, куда будет обращаться вебхук;
    - выберите событие, на которое будет инициализироваться вебхук.



___рекомендуемый пример запроса___

```
def post_to_bitrix(res, url, host):
    data = {'url': url}
    res.update(data)
    url = f'http://{host}:5001/bitrix/post'
    response = requests.post(url, json=res)
    return response
```

***Авторизационные данные:***

- url вида "https://example.bitrix24.com/rest/1/33olqeits4avuyqu"

* для получения необходимо:*

- перейти во вкладку "приложения" -> разработчикам -> импортировать/экспортировать данные ->
импортировать/экспортировать контрагентов -> выбрать метод "crm.lead.list" (для получения лидов) /
"crm.lead.add"(для добавления) -> скопировать url из "Вебхук для вызова rest api"


1. Получить входящий вебхук с доступом CRM

   - Зайти в панель управления Битрикс 24, в выпадающем меню слева выбрать "Разработчикам"

   - Другое > Входящий вебхук

   - В настройке прав (внизу страницы) выбрать `CRM (crm)`

   - Скопировать ссылку из поля "Вебхук для вызова rest api"

     > Ссылка выглядит примерно так: `https://b24-ep1gyi.bitrix24.ru/rest/421/j9f2incnbdn2r3d5/`
   - Нажать "Сохранить"

   - URL этого вебхука понадобится в следующем пункте

2. Создать исходящий вебхук (для отправки событий)

   - Другое > Исходящий вебхук

   - В настройке событий выбрать 3 пункта: `Создание сделки (ONCRMDEALADD), Обновление сделки (ONCRMDEALUPDATE), Удаление сделки (ONCRMDEALDELETE)`

   - В поле "URL вашего обработчика" вставить `https://artginzburg.runkit.io/turnakolskiy-api/branches/master/:bitrixIncomingWebhook`

   - Заменить `:bitrixIncomingWebhook` на URL входящего вебхука из пункта 1 в [формате URL-encoded][urlencode]

     > Должно получиться что-то вроде: `https://artginzburg.runkit.io/turnakolskiy-api/branches/master/https%3A%2F%2Fb24-ep1gyi.bitrix24.ru%2Frest%2F421%2Fj9f2incnbdn2r3d5%2F`
   - Нажать "Сохранить"